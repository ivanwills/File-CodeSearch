#!/usr/bin/perl

# Created on: 2009-08-07 18:33:36
# Create by:  Ivan Wills
# $Id$
# $Revision$, $HeadURL$, $Date$
# $Revision$, $Source$, $Date$

use strict;
use warnings;
use version;
use Scalar::Util;
use List::Util;
#use List::MoreUtils;
use Getopt::Long;
use Pod::Usage;
use Data::Dumper qw/Dumper/;
use English qw/ -no_match_vars /;
use FindBin qw/$Bin/;
use File::CodeSearch;
use File::CodeSearch::RegexBuilder;
use File::CodeSearch::Files;

our $VERSION = version->new('0.0.1');
my ($name)   = $PROGRAM_NAME =~ m{^.*/(.*?)$}mxs;

my %option = (
	out     => undef,
	verbose => 0,
	man     => 0,
	help    => 0,
	VERSION => 0,
);

if ( !@ARGV ) {
	pod2usage( -verbose => 1 );
}

main();
exit 0;

sub main {

	Getopt::Long::Configure('bundling');
	GetOptions(
		\%option,
		'sre-all|all|A',
		'sre-words|words|w',
		'sre-ignore-case|ignore|i',
		'replace|r=s',
		'path|p=s',
		'follow-symlinks|links|l',
		'recurse|',
		'file-contains=s',
		'file-not-contains=s',
		'file-include|n=s',
		'file-include-glob=s',
		'file-include-type=s',
		'file-exclude|x=s',
		'file-exclude-glob=s',
		'file-exclude-type=s',
		'file-ignore=s',
		'file-ignore-add|d=s',
		'file-ignore-remove|r=s',
		'out-suround|s=n',
		'out-suround-before|f=n',
		'out-suround-after|a=n',
		'out-totals|t',
		'out-files-only|f',
		'project|P=s',
		'config|C=s',
		'verbose|v+',
		'man',
		'help',
		'VERSION!',
	) or pod2usage(2);

	if ( $option{'VERSION'} ) {
		print "$name Version = $VERSION\n";
		exit 1;
	}
	elsif ( $option{'man'} ) {
		pod2usage( -verbose => 2 );
	}
	elsif ( $option{'help'} ) {
		pod2usage( -verbose => 1 );
	}

	# do stuff here

	my $re = File::CodeSearch::RegexBuilder->new( re => \@ARGV );
	my $cs = File::CodeSearch->new( regex => $re );

	$option{path} ||= ['.'];

	my %found;
	$cs->search( sub {
			my ($line, $file, $line_no ) = @_;
			if ( !$found{$file} ) {
				print "${file}:\n";
			}
			$found{$file}++;
			printf "%4i: $line", $line_no;
		},
		@{ $option{path} }
	);

	return;
}

__DATA__

=head1 NAME

cs - Search & replace text (with some intelegence)

=head1 VERSION

This documentation refers to cs version 0.1.

=head1 SYNOPSIS

   cs [option] re
   cr [option] search replace

 OPTIONS:
  Search:
   -A --sre-all  Find all parts on regardless of order on the line
   -w --sre-words
                 Similar to --all but with out the reordering
   -i --sre-ignore-case
                 Turn off case sensitive searching
   -  --sre-
  Replace:
   -r --replace=string
                 String to replace found text with
  Files:
   -p --path=string
                 A colon seperated list of directories to search in
                 (Default current directory)
   -l --follow-symlinks
                 Follow symlinks to directories
      --no-follow-symlinks
                 Don't follow symlinks to directories
      --recurse  Recurse into subdirectories (Default)
      --no-recurse
                 Turns off recursing into subdirectories
      --file-contains=string
                 Only show results of search if the file (somewhere) also
                 contains this regex (Multiple)
      --file-not-contains=string
                 Only show results of search if the file does not contain
                 any where this regex
   -n --file-include=string
                 Only include files mathcing the regex (Multiple)
      --file-include-glob=string
                 Only include files matching this glob (Multiple)
      --file-include-type=string
                 Only include files the specified type (Mulitple)
                 see perldoc File::CodeSearch::FileTypes available types
   -x --file-exclude=string
                 Don't include files mathcing the regex (Multiple)
      --file-exclude-glob=string
                 Don't include files matching this glob (Multiple)
      --file-exclude-type=string
                 Don't include files the specified type (Mulitple)
                 see perldoc File::CodeSearch::FileTypes available types
      --file-ignore=string
                 Replace the default ignore regex
   -d --file-ignore-add=string
                 Add this regex to the list of ignored files
   -r --file-ignore-remove=string
                 Remove this regex to the list of ignored files
  Output:
   -s --out-suround=int
                 Show int lines before and after a match
   -f --out-suround-before=int
                 Show int lines before a match
   -a --out-suround-after=int
                 Show int lines after a match
   -t --out-totals
                 Show the total number of lines & files matched
   -f --out-files-only
                 Show only the file names containg matches
  Other:
   -P --project=string
                 Use the specified projects default settings
   -C --config=file
                 Use the specified file as the config file instead of the
                 deafult ~/.cs

   -v --verbose  Show more detailed option
      --version  Prints the version information
      --help     Prints this help information
      --man      Prints the full documentation for cs

=head1 DESCRIPTION

=head1 SUBROUTINES/METHODS

=head1 DIAGNOSTICS

=head1 CONFIGURATION AND ENVIRONMENT

=head1 DEPENDENCIES

=head1 INCOMPATIBILITIES

=head1 BUGS AND LIMITATIONS

There are no known bugs in this module.

Please report problems to Ivan Wills (ivan.wills@gmail.com).

Patches are welcome.

=head1 AUTHOR

Ivan Wills - (ivan.wills@gmail.com)

=head1 LICENSE AND COPYRIGHT

Copyright (c) 2009 Ivan Wills (14 Mullion Close, Hornsby Heights, NSW Australia 2077).
All rights reserved.

This module is free software; you can redistribute it and/or modify it under
the same terms as Perl itself. See L<perlartistic>.  This program is
distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE.

=cut
